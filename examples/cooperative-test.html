<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooperative Scheduler Test - tor-wasm</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 8px;
            color: #fff;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 24px;
        }
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 16px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #fff;
        }
        label {
            display: block;
            font-size: 13px;
            color: #888;
            margin-bottom: 6px;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
            margin-bottom: 12px;
        }
        textarea {
            min-height: 80px;
            font-family: monospace;
            resize: vertical;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }
        .status-dot.success { background: #10b981; }
        .status-dot.pending { background: #f59e0b; animation: pulse 1s infinite; }
        .status-dot.error { background: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #log {
            background: #0d1117;
            border-radius: 8px;
            padding: 12px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-entry { margin-bottom: 4px; }
        .log-time { color: #666; margin-right: 8px; }
        .log-info { color: #58a6ff; }
        .log-success { color: #3fb950; }
        .log-error { color: #f85149; }
        .log-response { color: #d29922; }
        .log-debug { color: #8b949e; }
        .info-box {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #10b981;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 16px;
        }
        .comparison-item {
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .comparison-item h3 {
            margin-bottom: 8px;
            color: #fff;
        }
        .comparison-item p {
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <span class="badge">Cooperative Scheduler</span>
        <h1>tor-wasm Cooperative Scheduler Test</h1>
        <p class="subtitle">Testing the novel checkout/return pattern for WASM Tor</p>

        <div class="info-box">
            <strong>What is this?</strong> This page tests the new cooperative scheduler architecture that
            solves the RefCell borrow-across-await bug in WASM. The scheduler uses a "checkout/return"
            pattern where the circuit is temporarily removed during async I/O, ensuring no borrows span await points.
        </div>

        <div class="status-bar">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Ready to test</span>
        </div>

        <div class="card">
            <h2>Configuration</h2>
            <label>Bridge URL (WebSocket)</label>
            <input type="text" id="bridge-url" value="ws://localhost:8080">

            <label>Test Mode</label>
            <select id="test-mode">
                <option value="httpbin">httpbin.org POST (HTTP)</option>
                <option value="httpbin-https">httpbin.org POST (HTTPS)</option>
                <option value="anthropic">Anthropic Claude API (requires key)</option>
            </select>

            <label>API Key (for Anthropic only)</label>
            <input type="password" id="api-key" placeholder="sk-ant-...">
        </div>

        <div class="comparison">
            <div class="comparison-item">
                <h3>Old Pattern (fetch_post)</h3>
                <p>Uses Rc&lt;RefCell&lt;Circuit&gt;&gt; directly. Can cause "recursive use of an object" panic when borrows span await points.</p>
            </div>
            <div class="comparison-item">
                <h3>New Pattern (fetch_post_cooperative)</h3>
                <p>Uses CooperativeCircuit with checkout/return. Circuit is removed from RefCell during async I/O, preventing borrow conflicts.</p>
            </div>
        </div>

        <div class="card">
            <h2>Tests</h2>
            <button class="btn-primary" onclick="testCooperative()">Test fetch_post_cooperative()</button>
            <button class="btn-secondary" onclick="testOld()">Test fetch_post() (old)</button>
            <button class="btn-danger" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="card">
            <h2>Log Output</h2>
            <div id="log"></div>
        </div>
    </div>

    <script type="module">
        import init, { TorClient } from '../pkg/tor_wasm.js';

        let client = null;
        let wasmReady = false;

        // Initialize WASM
        try {
            await init();
            wasmReady = true;
            log('success', 'WASM module initialized successfully');
        } catch (e) {
            log('error', `WASM init failed: ${e.message}`);
        }

        window.testCooperative = async () => {
            if (!wasmReady) {
                log('error', 'WASM not ready');
                return;
            }

            const bridgeUrl = document.getElementById('bridge-url').value;
            const testMode = document.getElementById('test-mode').value;
            const apiKey = document.getElementById('api-key').value;

            setStatus('pending', 'Running cooperative test...');
            log('info', '=== COOPERATIVE SCHEDULER TEST ===');
            log('info', `Test mode: ${testMode}`);

            try {
                const startTotal = Date.now();

                // Create client and bootstrap
                log('info', `Connecting to bridge: ${bridgeUrl}`);
                client = await new TorClient(bridgeUrl);
                log('success', 'Connected to bridge');

                log('info', 'Bootstrapping Tor network...');
                await client.bootstrap();
                log('success', 'Bootstrap complete');

                // Get test configuration
                const { url, headers, body } = getTestConfig(testMode, apiKey);
                log('info', `Target: ${url}`);
                log('debug', `Headers: ${headers}`);
                log('debug', `Body: ${body.substring(0, 100)}...`);

                // Run the COOPERATIVE version
                log('info', 'Calling fetch_post_cooperative()...');
                const apiStart = Date.now();

                const response = await client.fetch_post_cooperative(url, headers, body);

                const apiTime = ((Date.now() - apiStart) / 1000).toFixed(2);
                const totalTime = ((Date.now() - startTotal) / 1000).toFixed(2);

                log('success', `Response received in ${apiTime}s`);
                log('response', `Response length: ${response.length} bytes`);

                // Show response preview
                const preview = response.length > 500 ? response.substring(0, 500) + '...' : response;
                log('response', `Response: ${preview}`);

                log('success', `=== TEST PASSED (${totalTime}s total) ===`);
                setStatus('success', 'Cooperative test passed!');

            } catch (e) {
                log('error', `Test failed: ${e.message || e}`);
                log('error', `Stack: ${e.stack || 'N/A'}`);
                setStatus('error', 'Test failed');
            }
        };

        window.testOld = async () => {
            if (!wasmReady) {
                log('error', 'WASM not ready');
                return;
            }

            const bridgeUrl = document.getElementById('bridge-url').value;
            const testMode = document.getElementById('test-mode').value;
            const apiKey = document.getElementById('api-key').value;

            setStatus('pending', 'Running old pattern test...');
            log('info', '=== OLD PATTERN TEST (fetch_post) ===');
            log('info', `Test mode: ${testMode}`);

            try {
                const startTotal = Date.now();

                // Create client and bootstrap
                log('info', `Connecting to bridge: ${bridgeUrl}`);
                client = await new TorClient(bridgeUrl);
                log('success', 'Connected to bridge');

                log('info', 'Bootstrapping Tor network...');
                await client.bootstrap();
                log('success', 'Bootstrap complete');

                // Get test configuration
                const { url, headers, body } = getTestConfig(testMode, apiKey);
                log('info', `Target: ${url}`);

                // Run the OLD version
                log('info', 'Calling fetch_post() (old pattern)...');
                const apiStart = Date.now();

                const response = await client.fetch_post(url, headers, body);

                const apiTime = ((Date.now() - apiStart) / 1000).toFixed(2);
                const totalTime = ((Date.now() - startTotal) / 1000).toFixed(2);

                log('success', `Response received in ${apiTime}s`);
                log('response', `Response length: ${response.length} bytes`);

                const preview = response.length > 500 ? response.substring(0, 500) + '...' : response;
                log('response', `Response: ${preview}`);

                log('success', `=== TEST PASSED (${totalTime}s total) ===`);
                setStatus('success', 'Old pattern test passed!');

            } catch (e) {
                log('error', `Test failed: ${e.message || e}`);

                // Check if this is the RefCell borrow panic
                if (e.message && e.message.includes('recursive use of an object')) {
                    log('error', '>>> This is the RefCell borrow-across-await bug! <<<');
                    log('info', 'The cooperative scheduler fixes this issue.');
                }

                setStatus('error', 'Test failed');
            }
        };

        function getTestConfig(mode, apiKey) {
            switch (mode) {
                case 'httpbin':
                    return {
                        url: 'http://httpbin.org/post',
                        headers: JSON.stringify({
                            'content-type': 'application/json',
                            'user-agent': 'tor-wasm-test'
                        }),
                        body: JSON.stringify({
                            test: 'cooperative_scheduler',
                            timestamp: Date.now()
                        })
                    };
                case 'httpbin-https':
                    return {
                        url: 'https://httpbin.org/post',
                        headers: JSON.stringify({
                            'content-type': 'application/json',
                            'user-agent': 'tor-wasm-test'
                        }),
                        body: JSON.stringify({
                            test: 'cooperative_scheduler_https',
                            timestamp: Date.now()
                        })
                    };
                case 'anthropic':
                    if (!apiKey) {
                        throw new Error('API key required for Anthropic test');
                    }
                    return {
                        url: 'https://api.anthropic.com/v1/messages',
                        headers: JSON.stringify({
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'content-type': 'application/json'
                        }),
                        body: JSON.stringify({
                            model: 'claude-3-haiku-20240307',
                            max_tokens: 64,
                            messages: [{ role: 'user', content: 'Say "Hello from Tor!" in exactly 5 words.' }]
                        })
                    };
                default:
                    throw new Error(`Unknown test mode: ${mode}`);
            }
        }

        window.clearLog = () => {
            document.getElementById('log').innerHTML = '';
            setStatus('', 'Ready to test');
        };

        function log(level, message) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;
            const time = new Date().toLocaleTimeString('en-US', {
                hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3
            });
            entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${level.toUpperCase()}]`, message);
        }

        function setStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const textEl = document.getElementById('status-text');
            dot.className = 'status-dot ' + status;
            textEl.textContent = text;
        }
    </script>
</body>
</html>
